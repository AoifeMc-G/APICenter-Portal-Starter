<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDN Performance Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .result { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 3px; }
        .success { background-color: #d4edda; color: #155724; }
        .warning { background-color: #fff3cd; color: #856404; }
        .error { background-color: #f8d7da; color: #721c24; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üöÄ CDN Configuration Test Suite</h1>
    
    <div class="test-section">
        <h2>1. Current URL Analysis</h2>
        <div id="url-info"></div>
        <button onclick="analyzeCurrentURL()">Analyze Current URL</button>
    </div>

    <div class="test-section">
        <h2>2. Response Headers Check</h2>
        <div id="headers-info"></div>
        <button onclick="checkResponseHeaders()">Check Headers</button>
    </div>

    <div class="test-section">
        <h2>3. Performance Metrics</h2>
        <div id="performance-info"></div>
        <button onclick="checkPerformance()">Check Performance</button>
    </div>

    <div class="test-section">
        <h2>4. Asset Loading Test</h2>
        <div id="assets-info"></div>
        <button onclick="testAssetLoading()">Test Asset Loading</button>
    </div>

    <div class="test-section">
        <h2>5. CDN Edge Location Test</h2>
        <div id="cdn-info"></div>
        <button onclick="testCDNEdge()">Test CDN Edge</button>
    </div>

    <script>
        function analyzeCurrentURL() {
            const urlInfo = document.getElementById('url-info');
            const currentURL = window.location.href;
            const hostname = window.location.hostname;
            
            let analysis = `<div class="result">
                <strong>Current URL:</strong> ${currentURL}<br>
                <strong>Hostname:</strong> ${hostname}<br>
            `;
            
            if (hostname.includes('azurestaticapps.net')) {
                analysis += '<span class="success">‚úÖ Direct Static Web App access detected</span><br>';
            } else if (hostname.includes('azurefd.net')) {
                analysis += '<span class="success">‚úÖ Azure Front Door CDN access detected</span><br>';
            } else if (hostname.includes('api.kantar.com')) {
                analysis += '<span class="success">‚úÖ Custom domain via Front Door detected</span><br>';
            } else {
                analysis += '<span class="warning">‚ö†Ô∏è Unknown hosting source</span><br>';
            }
            
            analysis += '</div>';
            urlInfo.innerHTML = analysis;
        }

        async function checkResponseHeaders() {
            const headersInfo = document.getElementById('headers-info');
            try {
                const response = await fetch(window.location.href, { method: 'HEAD' });
                const headers = {};
                for (let [key, value] of response.headers) {
                    headers[key] = value;
                }
                
                let headerAnalysis = '<div class="result"><strong>Key CDN Headers:</strong><br><pre>';
                
                // Check for CDN-specific headers
                const cdnHeaders = [
                    'x-cdn-optimized',
                    'cache-control',
                    'etag',
                    'vary',
                    'x-azure-ref',
                    'x-cache',
                    'cf-ray',
                    'server'
                ];
                
                cdnHeaders.forEach(header => {
                    if (headers[header]) {
                        headerAnalysis += `${header}: ${headers[header]}\n`;
                    }
                });
                
                headerAnalysis += '</pre>';
                
                // Analysis
                if (headers['x-cdn-optimized']) {
                    headerAnalysis += '<span class="success">‚úÖ CDN optimization header found</span><br>';
                }
                if (headers['cache-control']) {
                    headerAnalysis += '<span class="success">‚úÖ Cache control configured</span><br>';
                }
                if (headers['vary']) {
                    headerAnalysis += '<span class="success">‚úÖ Compression optimization enabled</span><br>';
                }
                
                headerAnalysis += '</div>';
                headersInfo.innerHTML = headerAnalysis;
            } catch (error) {
                headersInfo.innerHTML = `<div class="result error">Error checking headers: ${error.message}</div>`;
            }
        }

        function checkPerformance() {
            const performanceInfo = document.getElementById('performance-info');
            
            if ('performance' in window) {
                const navigation = performance.getEntriesByType('navigation')[0];
                const resources = performance.getEntriesByType('resource');
                
                let perfAnalysis = `<div class="result">
                    <strong>Page Load Performance:</strong><br>
                    DNS Lookup: ${Math.round(navigation.domainLookupEnd - navigation.domainLookupStart)}ms<br>
                    Connection: ${Math.round(navigation.connectEnd - navigation.connectStart)}ms<br>
                    Response: ${Math.round(navigation.responseEnd - navigation.responseStart)}ms<br>
                    DOM Load: ${Math.round(navigation.domContentLoadedEventEnd - navigation.navigationStart)}ms<br>
                    Total Load: ${Math.round(navigation.loadEventEnd - navigation.navigationStart)}ms<br><br>
                    
                    <strong>Resource Summary:</strong><br>
                    Total Resources: ${resources.length}<br>
                `;
                
                // Analyze resource loading
                const fastResources = resources.filter(r => r.duration < 100).length;
                const slowResources = resources.filter(r => r.duration > 1000).length;
                
                perfAnalysis += `Fast Loading (&lt;100ms): ${fastResources}<br>`;
                perfAnalysis += `Slow Loading (&gt;1000ms): ${slowResources}<br>`;
                
                if (slowResources === 0) {
                    perfAnalysis += '<span class="success">‚úÖ All resources loading efficiently</span><br>';
                } else if (slowResources < 3) {
                    perfAnalysis += '<span class="warning">‚ö†Ô∏è Some resources could be optimized</span><br>';
                } else {
                    perfAnalysis += '<span class="error">‚ùå Multiple slow resources detected</span><br>';
                }
                
                perfAnalysis += '</div>';
                performanceInfo.innerHTML = perfAnalysis;
            } else {
                performanceInfo.innerHTML = '<div class="result error">Performance API not available</div>';
            }
        }

        function testAssetLoading() {
            const assetsInfo = document.getElementById('assets-info');
            const resources = performance.getEntriesByType('resource');
            
            let assetAnalysis = '<div class="result"><strong>Asset Analysis:</strong><br>';
            
            const assetTypes = {
                js: resources.filter(r => r.name.includes('.js')),
                css: resources.filter(r => r.name.includes('.css')),
                images: resources.filter(r => /\.(png|jpg|jpeg|gif|svg|webp|avif)/.test(r.name)),
                fonts: resources.filter(r => /\.(woff|woff2|ttf|eot)/.test(r.name))
            };
            
            Object.entries(assetTypes).forEach(([type, assets]) => {
                if (assets.length > 0) {
                    const avgDuration = assets.reduce((sum, asset) => sum + asset.duration, 0) / assets.length;
                    assetAnalysis += `${type.toUpperCase()}: ${assets.length} files, avg ${Math.round(avgDuration)}ms<br>`;
                }
            });
            
            // Check if assets are using CDN-optimized paths
            const cdnOptimizedAssets = resources.filter(r => r.name.includes('/assets/')).length;
            assetAnalysis += `<br>CDN-optimized assets: ${cdnOptimizedAssets}<br>`;
            
            if (cdnOptimizedAssets > 0) {
                assetAnalysis += '<span class="success">‚úÖ Assets using optimized paths</span><br>';
            }
            
            assetAnalysis += '</div>';
            assetsInfo.innerHTML = assetAnalysis;
        }

        async function testCDNEdge() {
            const cdnInfo = document.getElementById('cdn-info');
            
            try {
                // Test multiple endpoints
                const endpoints = [
                    window.location.origin,
                    'https://afd-ki-api-glb-001-apic-endpoint-craggrgufpaph6f2.a03.azurefd.net',
                    'https://portal-uat.api.kantar.com'
                ];
                
                let cdnAnalysis = '<div class="result"><strong>CDN Endpoint Tests:</strong><br>';
                
                for (const endpoint of endpoints) {
                    try {
                        const start = performance.now();
                        const response = await fetch(endpoint, { method: 'HEAD', mode: 'no-cors' });
                        const duration = performance.now() - start;
                        
                        cdnAnalysis += `${endpoint}: ${Math.round(duration)}ms<br>`;
                    } catch (error) {
                        cdnAnalysis += `${endpoint}: Error - ${error.message}<br>`;
                    }
                }
                
                cdnAnalysis += '<br><span class="success">‚úÖ CDN edge location test completed</span></div>';
                cdnInfo.innerHTML = cdnAnalysis;
            } catch (error) {
                cdnInfo.innerHTML = `<div class="result error">CDN test error: ${error.message}</div>`;
            }
        }

        // Auto-run some tests on load
        window.addEventListener('load', () => {
            analyzeCurrentURL();
            setTimeout(checkPerformance, 1000);
        });
    </script>
</body>
</html>
